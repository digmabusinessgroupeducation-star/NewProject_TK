

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ПодразделениеКомпании = Справочники.ПодразделенияКомпании.НайтиПоКоду("000000006");
	Организация      = Справочники.Организации.НайтиПоКоду("GL000015");
	СкладОтправитель = Справочники.СкладыКомпании.НайтиПоКоду("удAT0013");
	СкладПолучатель  = Справочники.СкладыКомпании.НайтиПоКоду("удAT0016");
	ТорговаяПлощадка = Справочники.ТорговыеПлощадки.НайтиПоКоду("ХGL000281");
	
	ЗаполнитьТаблицуПеретаривания();
	СформироватьОтчетОстатки();
КонецПроцедуры


&НаКлиенте
Процедура ЗавершитьРаботуРабочегоМеста(Команда)		
	
	ЗавершитьРаботуСистемы(Истина, Ложь);
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиСобытийЭлементовФормы

&НаСервере
Процедура НоменклатураВыпускаПриИзмененииНаСервере()
 
	тНоменклатура = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул",НоменклатураВыпуска);

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Рецептура.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ Вт_Рецептура
		|ИЗ
		|	Документ.Рецептура КАК Рецептура
		|ГДЕ
		|	Рецептура.Проведен
		|	И Рецептура.Продукция = &Продукция
		|	И Рецептура.Актуальная
		|
		|УПОРЯДОЧИТЬ ПО
		|	Рецептура.Дата УБЫВ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РецептураТовары.Номенклатура КАК Номенклатура,
		|	РецептураТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	РецептураТовары.Коэффициент КАК Коэффициент,
		|	0 КАК Количество
		|ИЗ
		|	Вт_Рецептура КАК Вт_Рецептура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Рецептура.Товары КАК РецептураТовары
		|		ПО Вт_Рецептура.Ссылка = РецептураТовары.Ссылка.Ссылка
		|
		|УПОРЯДОЧИТЬ ПО
		|	РецептураТовары.Ссылка.Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Продукция", тНоменклатура);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда 
		ОбщегоНазначения.СообщитьПользователю("НЕТ актуальной рецептуры для данного товара");
	Иначе
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = Объект.Ингридиенты.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,Выборка);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураВыпускаПриИзменении(Элемент)
	Объект.Ингридиенты.Очистить();
	
	НоменклатураВыпускаПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ИнгридиентыНоменклатураПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Ингридиенты.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьЗаполнитьЕдиницуИзмеренийПоВладельцу", ТекущаяСтрока.ЕдиницаИзмерения);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущаяСтрока, СтруктураДействий, Неопределено);
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаПереработкиРасходНоменклатураПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.ТаблицаПереработкиРасход.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьЗаполнитьЕдиницуИзмеренийПоВладельцу", ТекущаяСтрока.ЕдиницаИзмерения);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущаяСтрока, СтруктураДействий, Неопределено);

КонецПроцедуры

&НаКлиенте
Процедура ТаблицаПереработкиПриходНоменклатураПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.ТаблицаПереработкиПриход.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьЗаполнитьЕдиницуИзмеренийПоВладельцу", ТекущаяСтрока.ЕдиницаИзмерения);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущаяСтрока, СтруктураДействий, Неопределено);

КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаСервере
Процедура СформироватьОтчетОстатки()
	
    СхемаКомпоновкиДанных = РеквизитФормыВЗначение("Объект").ПолучитьМакет("Остатки");
	
	Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
    ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
	
	ПараметрыДанных = Настройки.ПараметрыДанных.Элементы;
	
	СписокСкладов = Новый СписокЗначений;
	СписокСкладов.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("удAT0015"));
	СписокСкладов.Добавить(Справочники.СкладыКомпании.НайтиПоКоду("удAT0013"));
	
	ЭлементСкладыКомпании = ПараметрыДанных.Найти("СкладКомпании");
	ЭлементСкладыКомпании.Использование = Истина;
	ЭлементСкладыКомпании.Значение = СписокСкладов;

	ЭлементНачалоПериода = ПараметрыДанных.Найти("НачалоПериода");
	ЭлементНачалоПериода.Использование = Истина;
	ЭлементНачалоПериода.Значение = ТекущаяДатаСеанса()-7*24*3600;

	ЭлементКонецПериода = ПараметрыДанных.Найти("КонецПериода");
	ЭлементКонецПериода.Использование = Истина;
	ЭлементКонецПериода.Значение = ТекущаяДатаСеанса();

	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
    МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
    
    ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
    ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, , ДанныеРасшифровки);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
    ПроцессорВывода.УстановитьДокумент(тОстатки);
	
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных); 
		
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицуПеретаривания()
	
	СписокНоменклатуры = новый СписокЗначений;
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "12476")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10370")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10371")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10372")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10373")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10616")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10617")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10618")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10620")); 
	СписокНоменклатуры.Добавить(Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", "10371")); 
	
	Для Каждого стр из СписокНоменклатуры цикл
		НоваяСтрока = ТаблицаПеретарки.Добавить();
		НоваяСтрока.Номенклатура = стр.Значение;
	КонецЦикла;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьЗаполнитьЕдиницуИзмеренийПоВладельцу");
	
	ОбработкаТабличнойЧастиСервер.ОбработатьТЧ(ТаблицаПеретарки, СтруктураДействий, Неопределено);
	
КонецПроцедуры

&НаСервере
Функция ПеретаритьНаСервере()
	НачатьТранзакцию();
	
	Док = Документы.ВыпускПродукции.СоздатьДокумент();
	Док.Дата 						 = ТекущаяДатаСеанса();
	Док.Автор 						 = Пользователи.ТекущийПользователь();
	Док.ЗакрытиеЗаказовПокупателей 	 = 1;
	Док.РежимИспользованияАналогов 	 = Перечисления.РежимыИспользованияАналогов.Разрешить;
	Док.РежимРасчетаСписанияВПроизводство = Перечисления.РежимыРасчетаСписанияВПроизводство.ПоФакту;
	Док.ВидПроизводства 			 = Перечисления.ВидыПроизводства.ЗаготовкиНеГотовятся;
	Док.УчитыватьОстаткиБлюдНаСкладе = Ложь;
	Док.РазрешитьНедовложения 		 = Ложь;
	Док.ХозОперация  				 = Справочники.ХозОперации.ВыпускПродукции;
	Док.ПодразделениеКомпании 		 = ПодразделениеКомпании;
	Док.СкладКомпании 				 = СкладПолучатель;
	Док.ТорговаяПлощадка			 = СкладПолучатель.ТорговаяПлощадка;
	Док.Организация 				 = Организация;
	Док.УстановитьНовыйНомер();
	
	Для Каждого стр Из ТаблицаПеретарки Цикл
		Если стр.Количество = 0 Тогда 
			Продолжить;
		КонецЕсли;
		
		Рецептура = Документы.Рецептура.ПолучитьАктуальнуюРецептуру(Стр.Номенклатура);
		
		НоваяСтрока = Док.Продукция.Добавить(); 
		НоваяСтрока.Номенклатура 	  = Стр.Номенклатура;
		ЗаполнитьЗначенияСвойств(НоваяСтрока,Рецептура);
		НоваяСтрока.Количество 		  = Стр.Количество;
		НоваяСтрока.КоличествоБазовое = Стр.Количество;
		
		СтруктураДействий = Новый Структура;
		СтруктураДействий.Вставить("ПроверитьЗаполнитьРецептуру", Новый Структура("ПодразделениеКомпании", ПодразделениеКомпании));
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
		СтруктураДействий.Вставить("ПересчитатьСумму");
		СтруктураДействий.Вставить("ПересчитатьСуммуВсего");
		СтруктураДействий.Вставить("ПересчитатьСуммуНДС", "СуммаВсего");
		
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);
	КонецЦикла;
	
	Если Док.Продукция.Количество() = 0 Тогда 
		ОтменитьТранзакцию();
		Возврат Ложь;
	КонецЕсли;
	
	Документы.ВыпускПродукции.ПерезаполнитьИнгридиенты(Док);
		
	Док.Комментарий = "Перетаривание";
		
	Попытка
		Док.Записать(РежимЗаписиДокумента.Проведение);
		ОбщегоНазначения.СообщитьПользователю("Документ записан "+ док.Ссылка,Док.Ссылка);
		ЗафиксироватьТранзакцию();
				
		Для Каждого стр из ТаблицаПеретарки цикл
			Стр.Количество = 0 ;
		КонецЦикла;
		
		ДокументДляПечати = Док;
		
		Возврат Истина;
	Исключение
		ОбщегоНазначения.СообщитьПользователю("Не удалось провести документ" + ОписаниеОшибки());
		ОтменитьТранзакцию();
		Возврат Ложь;
	КонецПопытки;
	
		
КонецФункции

&НаКлиенте
Процедура Перетарить(Команда)
	
	ПечататьДок = ПеретаритьНаСервере();
	
	Если ПечататьДок Тогда 
		МассивДокументов = Новый Массив;
		МассивДокументов.Добавить(ДокументДляПечати);
		ПараметрыПечати = Новый Структура;
		
		УправлениеПечатьюКлиент.ВыполнитьКомандуПечати("Документ.ВыпускПродукции", "Фасовка", МассивДокументов, ЭтаФорма, ПараметрыПечати);
		
	КонецЕсли;		
	
КонецПроцедуры

Процедура ПереработатьНаСервере()
	
	НачатьТранзакцию();
	
	Док = Документы.ТК_Переработка.СоздатьДокумент();
	Док.Дата 						 = ТекущаяДатаСеанса();
	Док.Автор 						 = Пользователи.ТекущийПользователь();
	Док.ХозОперация  				 = Справочники.ХозОперации.Переработка;
	Док.ПодразделениеКомпании 		 = ПодразделениеКомпании;
	Док.СкладКомпании 				 = СкладПолучатель;
	Док.ТорговаяПлощадка			 = СкладПолучатель.ТорговаяПлощадка;
	Док.Организация 				 = Организация;
	Док.УстановитьНовыйНомер();
	
	Продукция = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", НоменклатураВыпуска);
	Рецептура = Документы.Рецептура.ПолучитьАктуальнуюРецептуру(Продукция);
	
	Для Каждого стр из ТаблицаПереработкиРасход Цикл
		Если стр.Количество = 0 Тогда 
			Продолжить;
		Иначе
			НоваяСтрока = Док.Материалы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,стр);
		КонецЕсли;
	КонецЦикла;
	
	СтруктураДействий = Новый Структура;	
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");	

	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);

	Для Каждого стр из ТаблицаПереработкиПриход Цикл
		Если стр.Количество = 0 Тогда 
			Продолжить;
		Иначе
			НоваяСтрока = Док.Продукция.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,стр);
		КонецЕсли;
	КонецЦикла;

	СтруктураДействий = Новый Структура;	
	СтруктураДействий.Вставить("ЗаполнитьСтавкуНДСПоНоменклатуре");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");	
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС");
	СтруктураДействий.Вставить("ПересчитатьСумму");

	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);

	Док.Комментарий = Комментарий;
	
	Попытка
		Док.Записать(РежимЗаписиДокумента.Запись);
		ОбщегоНазначения.СообщитьПользователю("Документ записан "+ док.Ссылка,Док.Ссылка);
		
		ТаблицаПереработкиПриход.Очистить();
		ТаблицаПереработкиРасход.Очистить();
		
		ЗафиксироватьТранзакцию();
	Исключение
		ОбщегоНазначения.СообщитьПользователю("Не удалось записать документ "+ОписаниеОшибки());
		ОтменитьТранзакцию();
	КонецПопытки;

	
КонецПроцедуры

&НаКлиенте
Процедура Переработать(Команда)
	Если НЕ ТаблицаПереработкиПриход.Количество() = 0 Или НЕ ТаблицаПереработкиРасход.Количество()=0 Тогда 
		ПереработатьНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ВыпуститьПродукциюНаСервере()
	
	НачатьТранзакцию();
	
	Док = Документы.ВыпускПродукции.СоздатьДокумент();
	Док.Дата 						 = ТекущаяДатаСеанса();
	Док.Автор 						 = Пользователи.ТекущийПользователь();
	Док.ЗакрытиеЗаказовПокупателей 	 = 1;
	Док.РежимИспользованияАналогов 	 = Перечисления.РежимыИспользованияАналогов.Разрешить;
	Док.РежимРасчетаСписанияВПроизводство = Перечисления.РежимыРасчетаСписанияВПроизводство.ПоФакту;
	Док.ВидПроизводства 			 = Перечисления.ВидыПроизводства.ЗаготовкиНеГотовятся;
	Док.УчитыватьОстаткиБлюдНаСкладе = Ложь;
	Док.РазрешитьНедовложения 		 = Ложь;
	Док.ХозОперация  				 = Справочники.ХозОперации.ВыпускПродукцииСПеремещением;
	Док.ПодразделениеКомпании 		 = ПодразделениеКомпании;
	Док.СкладКомпании 				 = СкладОтправитель;
	Док.ТорговаяПлощадка			 = ТорговаяПлощадка;
	Док.СкладКомпанииПолучатель 	 = СкладПолучатель;
	Док.ТорговаяПлощадкаПолучатель   = СкладПолучатель.ТорговаяПлощадка;
	Док.Организация 				 = Организация;
	Док.УстановитьНовыйНомер();
	
	Продукция = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", НоменклатураВыпуска);
	Рецептура = Документы.Рецептура.ПолучитьАктуальнуюРецептуру(Продукция);
	
	НоваяСтрока = Док.Продукция.Добавить(); 
	НоваяСтрока.Номенклатура 	  = Продукция;
	ЗаполнитьЗначенияСвойств(НоваяСтрока,Рецептура);
	НоваяСтрока.Количество 		  = ФактВыпуска;
	НоваяСтрока.КоличествоБазовое = ФактВыпуска;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьЗаполнитьРецептуру", Новый Структура("ПодразделениеКомпании", ПодразделениеКомпании));
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуВсего");
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", "СуммаВсего");

	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);

	Документы.ВыпускПродукции.ПерезаполнитьИнгридиенты(Док);
	
	Для Каждого стр Из Объект.Ингридиенты Цикл
		СтрокаПродукции = Док.Ингредиенты.НайтиСтроки(Новый Структура("Номенклатура, Рецептура, Ингредиент", Продукция,Рецептура.Рецептура,стр.Номенклатура)); 
		
		Если  СтрокаПродукции.Количество() =  0 Тогда
			ДанныеПродукции = Док.Продукция[0];	
			ДанныеИнгредиент = Док.Ингредиенты.Добавить();			
			ЗаполнитьЗначенияСвойств(ДанныеИнгредиент, ДанныеПродукции, "Номенклатура, Рецептура");
			ДанныеИнгредиент.КоличествоНоменклатуры 		= ДанныеПродукции.Количество;
			ДанныеИнгредиент.ЕдиницаИзмеренияНоменклатуры 	= ДанныеПродукции.ЕдиницаИзмерения;
			ДанныеИнгредиент.КоэффициентНоменклатуры 		= ДанныеПродукции.Коэффициент;
			ДанныеИнгредиент.Ингредиент 					= стр.Номенклатура;
			ДанныеИнгредиент.ЕдиницаИзмеренияИнгредиента 	= стр.ЕдиницаИзмерения;
			ДанныеИнгредиент.КоэффициентИнгредиента 		= стр.Коэффициент;
			ДанныеИнгредиент.КоличествоИнгредиентаФакт 		= стр.Количество;
		Иначе
			СтрокаПродукции[0].КоличествоИнгредиентаФакт = стр.Количество; 
		КонецЕсли;
	КонецЦикла;
	
	
	Док.Комментарий = Продукция.Наименование;
	
	Попытка
		Док.Записать(РежимЗаписиДокумента.Запись);
		ОбщегоНазначения.СообщитьПользователю("Документ записан!!!");
		
		Объект.Ингридиенты.Очистить();
		ФактВыпуска = 0;
		
		ЗафиксироватьТранзакцию();
	Исключение
		ОбщегоНазначения.СообщитьПользователю("Не удалось записать документ "+ОписаниеОшибки());
		ОтменитьТранзакцию();
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыпуститьПродукцию(Команда)
	
	Если НЕ ФактВыпуска = 0 Тогда 
		ВыпуститьПродукциюНаСервере();
	Иначе
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не заполнено поле Факт Выпуска",,"ФактВыпуска");
	КонецЕсли;
	
КонецПроцедуры


#КонецОбласти



