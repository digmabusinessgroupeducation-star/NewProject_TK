


&НаКлиенте
Процедура ДеревоПриАктивизацииСтроки(Элемент)
	Элементы.ФормаЗагрузить.Доступность = СтрНайти("KMCX",Элемент.ТекущиеДанные.Категория) > 0;
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

&НаСервере
Функция ПоискСуществующегоКОАТУУ(Знач ПараметрыФормы)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КлассификаторКОАТУУ.Ссылка
	|ИЗ
	|	Справочник.КлассификаторКОАТУУ КАК КлассификаторКОАТУУ
	|ГДЕ
	|	КлассификаторКОАТУУ.Код = &Код";
	
	Запрос.УстановитьПараметр("Код", ПараметрыФормы.ЗначенияЗаполнения.Код);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура ВыполнитьВыбор(ТекущаяОбласть)
	
	Код         = ТабДокумент.Область(ТекущаяОбласть.Верх, ОбластьКодЛево,
	ТекущаяОбласть.Низ, ОбластьКодПраво).Текст;
	Наименование = ТабДокумент.Область(ТекущаяОбласть.Верх, ОбластьНаименованиеЛево,
	ТекущаяОбласть.Низ, ОбластьНаименованиеПраво).Текст;
	
	ЗначенияЗаполнения = Новый Структура("Код, Наименование",
	Код, СтрПолучитьСтроку(Наименование, 1));
	ПараметрыФормы = Новый Структура("ЗначенияЗаполнения", ЗначенияЗаполнения);
	
	ТекущийКОАТУУ = ПоискСуществующегоКОАТУУ(ПараметрыФормы);
	
	Если ТекущийКОАТУУ <> Неопределено Тогда
		
		ПараметрыФормы = Новый Структура("Ключ", ТекущийКОАТУУ);
		
		Сообщить(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='В справочнике ""Классификатор КОАТУУ"" уже существует элемент с кодом ""%1""! Открыт существующий';uk='У довіднику ""Класифікатор КОАТУУ"" вже існує елемент з кодом ""%1""! Відкритий існуючий'"), Код));
		
		ОткрытьФорму("Справочник.КлассификаторКОАТУУ.Форма.ФормаЭлемента",
		ПараметрыФормы, ЭтаФорма);
	Иначе	
		
		ОткрытьФорму("Справочник.КлассификаторКОАТУУ.Форма.ФормаЭлемента",
		ПараметрыФормы, ЭтаФорма);
	КонецЕсли;
	
	
КонецПроцедуры

&НаКлиенте
Процедура СтрокаПоискаПриИзменении(Элемент)
	
	ИскатьСтрокуВТаблице(Неопределено);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНД ФОРМЫ

&НаКлиенте
Процедура Выбрать(Команда)
	
	Область = Элементы.ТабДокумент.ТекущаяОбласть;
	ВыполнитьВыбор(Область);
	
КонецПроцедуры

&НаКлиенте
Процедура ТабДокументВыбор(Элемент, Область, СтандартнаяОбработка)
	
	Область = Элементы.ТабДокумент.ТекущаяОбласть;
	ВыполнитьВыбор(Область);
	
КонецПроцедуры

&НаКлиенте
Функция НайтиЭлементДЗ(Строки, СтрокаПоиска)
	
	//рекурсия блин 
	Для каждого Строка Из Строки Цикл
		Если Строка.Код = СтрокаПоиска Тогда
			//нашли стоку, созвращаем ее ИД
			Возврат Строка;
		Иначе	
			НайденныйЭлемент = НайтиЭлементДЗ(Строка.ПолучитьЭлементы(), СтрокаПоиска);
			Если НайденныйЭлемент <> Неопределено Тогда
				Возврат НайденныйЭлемент;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла; 
	//ни чего не наши
	Возврат Неопределено;
	
КонецФункции

&НаКлиенте
Процедура ИскатьСтрокуВТаблице(Команда)
	
	Если ПустаяСтрока(СтрокаПоиска) Тогда
		ПоказатьПредупреждение( , НСтр("ru='Не задана строка поиска';uk='Не заданий рядок пошуку'"));
		ТекущийЭлемент = Элементы.СтрокаПоиска;
		Возврат;
	КонецЕсли;
	
	Если ЭтоКАТОТТГ Тогда
		НайденныйЭлемент = НайтиЭлементДЗ(Дерево.ПолучитьЭлементы(),СтрокаПоиска);
		Если НайденныйЭлемент = Неопределено Тогда
			//элемент не найден, не позиционируемся
		Иначе	
			//нашли элемент, позиционируемся на него
			Элементы.Дерево.ТекущаяСтрока = НайденныйЭлемент.ПолучитьИдентификатор();
		КонецЕсли;
		
	Иначе
		НайденнаяОбласть = ТабДокумент.НайтиТекст(СтрокаПоиска, Элементы.ТабДокумент.ТекущаяОбласть,
		,,,, Истина);
		Если НайденнаяОбласть = Неопределено Тогда
			НайденнаяОбласть = ТабДокумент.НайтиТекст(СтрокаПоиска, , , , , , Истина);
			Если НайденнаяОбласть = Неопределено Тогда
				ОбщегоНазначенияКлиент.СообщитьПользователю(НСтр("ru='Строка не найдена';uk='Рядок не знайдено'"));
				ТекущийЭлемент = Элементы.СтрокаПоиска;
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		Элементы.ТабДокумент.ТекущаяОбласть = НайденнаяОбласть;
		//ТекущийЭлемент = Элементы.СтрокаПоиска;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоНаСервере(Макет)
	ПЗ = Новый ПостроительЗапроса;
	ПЗ.ИсточникДанных = Новый ОписаниеИсточникаДанных(Макет.Область());
	ПЗ.Выполнить();
	тдКАТОТТГ = ПЗ.Результат.Выгрузить();
	
	ДеревоКАТОТТГ = РеквизитФормыВЗначение("Дерево", Тип("ДеревоЗначений"));
	
	К = Ложь;
	ТекУр1 = "";
	ТекУр2 = "";
	ТекУр3 = "";
	ТекУр4 = "";
	ТекУр5 = "";
	
	Для Каждого Единица Из тдКАТОТТГ Цикл
		Если ТекУр1 <> Единица.ПершийРівень Тогда
			Строка1 = ДеревоКАТОТТГ.Строки.Добавить();	
			Строка1.Код = Единица.ПершийРівень;
			Строка1.Категория = Единица.КатегоріяОб_єкта;
			Строка1.Название = Единица.НазваОб_єкта;
			ТекУр1 = Единица.ПершийРівень;
			К = Единица.КатегоріяОб_єкта = "K";
			Продолжить;
		КонецЕсли;
		Если К Тогда
			Если ТекУр5 <> Единица.ДодатковийРівень Тогда
				Строка5 = Строка1.Строки.Добавить();	
				Строка5.Код = Единица.ДодатковийРівень;
				Строка5.Категория = Единица.КатегоріяОб_єкта;
				Строка5.Название = Единица.НазваОб_єкта;
				ТекУр5 = Единица.ДодатковийРівень;
				//Продолжить;
			КонецЕсли;
		Иначе
			Если ТекУр2 <> Единица.ДругийРівень Тогда
				Строка2 = Строка1.Строки.Добавить();	
				Строка2.Код = Единица.ДругийРівень;
				Строка2.Категория = Единица.КатегоріяОб_єкта;
				Строка2.Название = Единица.НазваОб_єкта;
				ТекУр2 = Единица.ДругийРівень;
				Продолжить;
			КонецЕсли;
			Если ТекУр3 <> Единица.ТретійРівень Тогда
				Строка3 = Строка2.Строки.Добавить();	
				Строка3.Код = Единица.ТретійРівень;
				Строка3.Категория = Единица.КатегоріяОб_єкта;
				Строка3.Название = Единица.НазваОб_єкта;
				ТекУр3 = Единица.ТретійРівень;
				Продолжить;
			КонецЕсли;
			Если ТекУр4 <> Единица.ЧетвертийРівень Тогда
				Строка4 = Строка3.Строки.Добавить();	
				Строка4.Код = Единица.ЧетвертийРівень;
				Строка4.Категория = Единица.КатегоріяОб_єкта;
				Строка4.Название = Единица.НазваОб_єкта;
				ТекУр4 = Единица.ЧетвертийРівень;
				Продолжить;
			КонецЕсли;
			Если ТекУр5 <> Единица.ДодатковийРівень Тогда
				Строка5 = Строка4.Строки.Добавить();	
				Строка5.Код = Единица.ДодатковийРівень;
				Строка5.Категория = Единица.КатегоріяОб_єкта;
				Строка5.Название = Единица.НазваОб_єкта;
				ТекУр5 = Единица.ДодатковийРівень;
				//Продолжить;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ЗначениеВРеквизитФормы(ДеревоКАТОТТГ,"Дерево");
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтоКАТОТТГ	= ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Параметры, "КАТОТТГ", Ложь);
	
	Если ЭтаФорма.Параметры.Свойство("СтрокаПоиска") Тогда
		СтрокаПоиска = ЭтаФорма.Параметры.СтрокаПоиска;
	КонецЕсли;
	
	Если ЭтоКАТОТТГ Тогда
		КатегорияПоиска	= ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Параметры, "КатегорияПоиска", "");
		Макет = Справочники.КлассификаторКОАТУУ.ПолучитьМакет("КлассификаторКАТОТТГ");
		ЗаполнитьДеревоНаСервере(Макет);
	Иначе
		Макет = Справочники.КлассификаторКОАТУУ.ПолучитьМакет("КлассификаторКОАТУУ");
		
		Макет.КодЯзыкаМакета = "ru";
		
		ТабДокумент.Вывести(Макет);
		ТабДокумент.ФиксацияСверху      = 2;
		
		ОбластьКодЛево          	= Макет.Области.Код.Лево;
		ОбластьКодПраво         	= Макет.Области.Код.Право;
		ОбластьНаименованиеЛево  	= Макет.Области.Наименование.Лево;
		ОбластьНаименованиеПраво 	= Макет.Области.Наименование.Право;
	КонецЕсли;
	
	Элементы.Дерево.Видимость = ЭтоКАТОТТГ;
	Элементы.ФормаЗагрузить.Видимость = ЭтоКАТОТТГ;
	Элементы.ФормаЗагрузить.КнопкаПоУмолчанию = ЭтоКАТОТТГ;
	Элементы.ТабДокумент.Видимость = Не ЭтоКАТОТТГ;
	Элементы.ФормаВыбрать.Видимость = Не ЭтоКАТОТТГ;
	Элементы.ФормаВыбрать.КнопкаПоУмолчанию = Не ЭтоКАТОТТГ;
	
КонецПроцедуры


&НаКлиенте
Процедура Загрузить(Команда)
	
	Цепочка = Новый Структура;
	ТекущиеДанные = Элементы.Дерево.ТекущиеДанные;
	ПодСтроки = Элементы.Дерево.ТекущиеДанные.ПолучитьЭлементы();
	МассивЭлементов = Новый Массив;
	Для Каждого Элемент Из ПодСтроки Цикл
		Уровень = Новый Структура("Код, Категория, Название");
		ЗаполнитьЗначенияСвойств(Уровень,Элемент);
		МассивЭлементов.Добавить(Уровень);
		Цепочка.Вставить("Уровень5",МассивЭлементов);
	КонецЦикла;
	
	МассивЭлементов = Новый Массив;
	Уровень = Новый Структура("Код, Категория, Название");
	ЗаполнитьЗначенияСвойств(Уровень,ТекущиеДанные);
	МассивЭлементов.Добавить(Уровень);
	Цепочка.Вставить("Уровень4",МассивЭлементов);
	
	Родитель = ТекущиеДанные.ПолучитьРодителя();
	Если Родитель <> Неопределено Тогда
		МассивЭлементов = Новый Массив;
		Уровень = Новый Структура("Код, Категория, Название");
		ЗаполнитьЗначенияСвойств(Уровень,Родитель);
		МассивЭлементов.Добавить(Уровень);
		Цепочка.Вставить("Уровень3",МассивЭлементов);
		
		Родитель = Родитель.ПолучитьРодителя();
		Если Родитель <> Неопределено Тогда
			МассивЭлементов = Новый Массив;
			Уровень = Новый Структура("Код, Категория, Название");
			ЗаполнитьЗначенияСвойств(Уровень,Родитель);
			МассивЭлементов.Добавить(Уровень);
			Цепочка.Вставить("Уровень2",МассивЭлементов);
			
			Родитель = Родитель.ПолучитьРодителя();
			Если Родитель <> Неопределено Тогда
				МассивЭлементов = Новый Массив;
				Уровень = Новый Структура("Код, Категория, Название");
				ЗаполнитьЗначенияСвойств(Уровень,Родитель);
				МассивЭлементов.Добавить(Уровень);
				Цепочка.Вставить("Уровень1",МассивЭлементов);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если Цепочка.Свойство("Уровень1") Тогда
		СсылкаУровень1 = СсылкаУровень(Цепочка.Уровень1[0]);
	КонецЕсли;
	Если Цепочка.Свойство("Уровень2") Тогда
		СсылкаУровень2 = СсылкаУровень(Цепочка.Уровень2[0],СсылкаУровень1);
	КонецЕсли;
	Если Цепочка.Свойство("Уровень3") Тогда
		СсылкаУровень3 = СсылкаУровень(Цепочка.Уровень3[0],СсылкаУровень1,СсылкаУровень2);
	КонецЕсли;
	Если Цепочка.Свойство("Уровень4") Тогда
		СсылкаУровень4 = СсылкаУровень(Цепочка.Уровень4[0],СсылкаУровень1,СсылкаУровень2,СсылкаУровень3);
	КонецЕсли;
	Если Цепочка.Свойство("Уровень5") Тогда
		Для Каждого Район Из Цепочка.Уровень5 Цикл
			Если ТекущиеДанные.Категория = "K" Тогда 
				СсылкаУровень5 = СсылкаУровень(Район,СсылкаУровень4,СсылкаУровень4,СсылкаУровень4,СсылкаУровень4);
			Иначе
				СсылкаУровень5 = СсылкаУровень(Район,СсылкаУровень1,СсылкаУровень2,СсылкаУровень3,СсылкаУровень4);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	
	
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция СсылкаУровень(Данные,СсылкаУровень1 = Неопределено,СсылкаУровень2 = Неопределено,СсылкаУровень3 = Неопределено,СсылкаУровень4 = Неопределено)
	
	КатегорияПоКАТОТТГ = Перечисления.КатегорияПоКАТОТТГ;
	
	СоотвКатегории = Новый Соответствие;
	СоотвКатегории.Вставить("O",КатегорияПоКАТОТТГ.Область);
	СоотвКатегории.Вставить("K",КатегорияПоКАТОТТГ.ГородСпецСтатус);
	СоотвКатегории.Вставить("P",КатегорияПоКАТОТТГ.РайонОбласти);
	СоотвКатегории.Вставить("H",КатегорияПоКАТОТТГ.Община);
	СоотвКатегории.Вставить("M",КатегорияПоКАТОТТГ.Город);
	СоотвКатегории.Вставить("X",КатегорияПоКАТОТТГ.Поселок);
	СоотвКатегории.Вставить("C",КатегорияПоКАТОТТГ.Село);
	СоотвКатегории.Вставить("B",КатегорияПоКАТОТТГ.РайонГорода);
	
	СправочникиКлассификаторКОАТУУ = Справочники.КлассификаторКОАТУУ;
	
	СсылкаУровень = СправочникиКлассификаторКОАТУУ.НайтиПоКоду(Данные.Код);
	Если СсылкаУровень.Пустая() Тогда
		ОбъектУровень = СправочникиКлассификаторКОАТУУ.СоздатьЭлемент();
		ОбъектУровень.Код = Данные.Код;
		ОбъектУровень.Категория = СоотвКатегории.Получить(Данные.Категория);
		ОбъектУровень.Наименование = Данные.Название;
		Если ЗначениеЗаполнено(СсылкаУровень1) Тогда
			ОбъектУровень.Родитель = СсылкаУровень1;	
			ОбъектУровень.Область = СсылкаУровень1;	
			Если ЗначениеЗаполнено(СсылкаУровень2) Тогда
				ОбъектУровень.Родитель = СсылкаУровень2;	
				ОбъектУровень.РайонОбласти = СсылкаУровень2;	
				Если ЗначениеЗаполнено(СсылкаУровень3) Тогда
					ОбъектУровень.Родитель = СсылкаУровень3;	
					ОбъектУровень.ТерриториальнаяОбщина = СсылкаУровень3;	
					Если ЗначениеЗаполнено(СсылкаУровень4) Тогда
						ОбъектУровень.Родитель = СсылкаУровень4;	
						ОбъектУровень.НаселенныйПункт = СсылкаУровень4;	
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		ОбъектУровень.Записать();
		СсылкаУровень = ОбъектУровень.Ссылка;
	КонецЕсли;
	
	Возврат СсылкаУровень;
	
КонецФункции
